<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заявка на предоставление доступа</title>
    <link rel="stylesheet" href="/css/site.css">
</head>
<body>
    <div class="container">
        <h1>Заявка на предоставление доступа</h1>
        <form id="accessForm" class="contact-form" novalidate>
            <div class="form-group">
                <label for="name">Фамилия, собственное имя, отчество (если таковое имеется)</label>
                <input type="text" id="name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="unit">Структурное подразделение</label>
                <input type="text" id="unit" name="unit" required>
            </div>
            
            <div class="form-group">
                <label for="position">Должность</label>
                <input type="text" id="position" name="position" required>
            </div>

            <div class="form-group">
                <label for="date-of-employment">Дата трудоустройства</label>
                <input type="date" id="date-of-employment" name="date-of-employment" required>
            </div>

            <div class="form-group">
                <label for="phone">Мобильный телефон</label>
                <input type="tel" id="phone" name="phone" required>
            </div>

            <div class="form-group">
                <label for="birth-date">Дата рождения</label>
                <input type="date" id="birth-date" name="birth-date" required>
            </div>
            
            <div class="italic-text">
                <p><em>Заполняется при заключении договора с подрядчиком:</em></p>
            </div>

            <div class="form-group">
                <label for="contract-date">Дата заключения договора</label>
                <input type="date" id="contract-date" name="contract-date">
            </div>

             <div class="form-group">
                <label for="deadline">Сроки выполнения работы (оказания услуг)</label>
                <input type="text" id="deadline" name="deadline">
            </div>

            <div class="form-group">
                <label for="curator-name">Фамилия, собственное имя, отчество (если таковое имеется) ответственного лица, который курирует деятельность подрядчика</label>
                <input type="text" id="curator-name" name="curator-name">
            </div>

            <div class="form-group">
                <label for="curator-position">Должность ответственного лица, который курирует деятельность подрядчика</label>
                <input type="text" id="curator-position" name="curator-position">
            </div>

            <div class="form-divider"></div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="removable-media" name="removable-media">
                    <label for="removable-media">Разрешить подключение съемного носителя информации</label>
                </div>
                <div class="form-note">
                    <label for="removable-media-note">Примечание</label>
                    <input type="text" id="removable-media-note" name="removable-media-note">
                </div>
            </div>

            <div class="italic-text">
                <p><em>Разрешить удаленный доступ к следующим ресурсам:</em></p>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="sed-access" name="sed-access">
                    <label for="sed-access">система электронного документооборота</label>
                </div>
                <div class="form-note">
                    <label for="sed-access-note">Примечание</label>
                    <input type="text" id="sed-access-note" name="sed-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="arm-mis-access" name="arm-mis-access">
                    <label for="arm-mis-access">АРМ Медицинской информационной системы «МАПСОФТ»</label>
                </div>
                <div class="form-note">
                    <label for="arm-mis-access-note">Примечание</label>
                    <input type="text" id="arm-mis-access-note" name="arm-mis-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="arm-bookkeeper-access" name="arm-bookkeeper-access">
                    <label for="arm-bookkeeper-access">АРМ бухгалтерский комплекс «МАПСФОТ»</label>
                </div>
                <div class="form-note">
                    <label for="arm-bookkeeper-access-note">Примечание</label>
                    <input type="text" id="arm-bookkeeper-access-note" name="arm-bookkeeper-access-note">
                </div>
            </div>
            
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="arm-mis-pn-access" name="arm-mis-pn-access">
                    <label for="arm-mis-pn-access">АРМ Медицинской информационной системы «МАПСОФТ» (база данных психоневрологического диспансера)</label>
                </div>
                <div class="form-note">
                    <label for="arm-mis-pn-access-note">Примечание</label>
                    <input type="text" id="arm-mis-pn-access-note" name="arm-mis-pn-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="email-access" name="email-access">
                    <label for="email-access">электронный почтовый ящик</label>
                </div>
                <div class="form-note">
                    <label for="email-access-note">Примечание</label>
                    <input type="text" id="email-access-note" name="email-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="ria-access" name="ria-access">
                    <label for="ria-access">РИАС «Кадры»</label>
                </div>
                <div class="form-note">
                    <label for="ria-access-note">Примечание</label>
                    <input type="text" id="ria-access-note" name="ria-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="rtc-access" name="rtc-access">
                    <label for="rtc-access">Республиканская телемедицинская система консультирования</label>
                </div>
                <div class="form-note">
                    <label for="rtc-access-note">Примечание</label>
                    <input type="text" id="rtc-access-note" name="rtc-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="hiv-access" name="hiv-access">
                    <label for="hiv-access">Республиканский регистр пациентов с ВИЧ</label>
                </div>
                <div class="form-note">
                    <label for="hiv-access-note">Примечание</label>
                    <input type="text" id="hiv-access-note" name="hiv-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="eis-access" name="eis-access">
                    <label for="eis-access">АИС «Эндопротезирование»</label>
                </div>
                <div class="form-note">
                    <label for="eis-access-note">Примечание</label>
                    <input type="text" id="eis-access-note" name="eis-access-note">
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="access-control-system-access" name="access-control-system-access">
                    <label for="access-control-system-access">Электронный  пропуск системы контроля доступа</label>
                </div>
                <div class="form-note">
                    <label for="access-control-system-access-note">Примечание</label>
                    <input type="text" id="access-control-system-access-note" name="access-control-system-access-note">
                </div>
            </div>
            
            <div class="form-divider"></div>

            <div class="form-group">
                <label for="additional-access">Дополнительно разрешить доступ к следующим информационным ресурсам и сервисам:</label>
                <textarea type="text" id="additional-access" name="additional-access"></textarea>
            </div>

            <div class="form-divider"></div>

            <div class="form-group">
                <label for="additional-software">Прошу установить следующее дополнительное программное обеспечение, не входящее в состав типового рабочего места (типовой состав: Word, Excel, Adobe pdf reader, ABBYY FineReader):</label>
                <textarea type="text" id="additional-software" name="additional-software"></textarea>
            </div>

            
            <button type="submit" class="submit-btn">Отправить</button>
        </form>
    </div>

    <script>
        document.getElementById('accessForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Создаем объект для JSON
            const formData = {};
            
            // Собираем данные из формы
            const formElements = this.elements;
            for (let element of formElements) {
                if (element.name) {
                    if (element.type === 'checkbox') {
                        formData[element.name] = element.checked;
                    } else if (element.type === 'date') {
                        const dateValue = element.value;
                        formData[element.name] = dateValue;
                    } else {
                        formData[element.name] = element.value;
                    }
                }
            }
            
            try {
                console.log('Отправляемые данные:', formData);
                const response = await fetch('/api/AccessRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/pdf'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    // Создаем модальное окно для PDF
                    const modal = document.createElement('div');
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    modal.style.zIndex = '1000';

                    const modalContent = document.createElement('div');
                    modalContent.style.backgroundColor = 'white';
                    modalContent.style.padding = '20px';
                    modalContent.style.borderRadius = '5px';
                    modalContent.style.width = '80%';
                    modalContent.style.height = '80%';
                    modalContent.style.display = 'flex';
                    modalContent.style.flexDirection = 'column';

                    const header = document.createElement('div');
                    header.style.display = 'flex';
                    header.style.justifyContent = 'space-between';
                    header.style.marginBottom = '10px';

                    const title = document.createElement('h2');
                    title.textContent = 'Ваш документ готов';
                    header.appendChild(title);

                    const closeButton = document.createElement('button');
                    closeButton.textContent = '✕';
                    closeButton.style.border = 'none';
                    closeButton.style.background = 'none';
                    closeButton.style.fontSize = '20px';
                    closeButton.style.cursor = 'pointer';
                    closeButton.onclick = () => {
                        document.body.removeChild(modal);
                        window.location.href = '/';
                    };
                    header.appendChild(closeButton);

                    const pdfContainer = document.createElement('iframe');
                    pdfContainer.style.width = '100%';
                    pdfContainer.style.height = '100%';
                    pdfContainer.style.border = 'none';
                    
                    // Создаем Blob из ответа и создаем URL для него
                    const pdfBlob = await response.blob();
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    pdfContainer.src = pdfUrl;

                    const printButton = document.createElement('button');
                    printButton.textContent = 'Распечатать';
                    printButton.style.marginTop = '10px';
                    printButton.style.padding = '10px 20px';
                    printButton.style.backgroundColor = '#4CAF50';
                    printButton.style.color = 'white';
                    printButton.style.border = 'none';
                    printButton.style.borderRadius = '5px';
                    printButton.style.cursor = 'pointer';
                    printButton.onclick = () => {
                        pdfContainer.contentWindow.print();
                    };

                    modalContent.appendChild(header);
                    modalContent.appendChild(pdfContainer);
                    modalContent.appendChild(printButton);
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);

                    this.reset();
                } else {
                    // Проверяем тип контента ответа
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        console.error('Ошибка сервера:', errorData);
                        alert(`Ошибка при отправке формы: ${errorData.detail || errorData.message || 'Неизвестная ошибка'}`);
                    } else {
                        alert('Произошла ошибка при отправке формы');
                    }
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при отправке формы. Проверьте консоль для деталей.');
            }
        });
    </script>
</body>
</html>